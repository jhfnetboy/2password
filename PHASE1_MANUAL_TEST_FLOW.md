# Phase 1 手动测试流程指南

## 概述
本文档为2Password Phase 1核心功能提供详细的手动测试流程，确保密码学和存储功能的可靠性和安全性。

## 环境准备

### 系统要求
- macOS 10.15+ (Catalina或更高版本)
- Rust 1.70+ 工具链
- 终端访问权限
- 临时文件读写权限

### 构建测试环境
```bash
# 1. 克隆项目
git clone <repository-url>
cd 2password
git checkout phase1

# 2. 构建项目
cargo build --release

# 3. 运行测试套件
cargo test --all-features

# 4. 检查测试通过情况
# 应显示: test result: ok. 48 passed; 0 failed
```

## 核心功能测试流程

### 测试流程 1: 密钥派生功能
**目标**: 验证Argon2id密钥派生的正确性和一致性

**测试步骤**:
1. 打开终端，进入项目目录
2. 运行密钥派生测试：
   ```bash
   cargo test test_key_derivation_consistency -- --nocapture
   ```
3. 观察输出时间（应 < 5秒）
4. 验证不同输入产生不同输出

**验证要点**:
- [ ] 相同密码+盐生成相同密钥
- [ ] 不同密码生成不同密钥  
- [ ] 不同盐生成不同密钥
- [ ] 派生时间在合理范围内 (< 5秒)

**数据验证**:
```bash
# 手动验证密钥派生一致性
cargo test test_key_derivation_performance -- --nocapture
# 输出示例: Key derivation took: 94.123ms ✅
```

### 测试流程 2: AES-GCM 加密验证
**目标**: 确保加密/解密功能正确性和安全性

**测试步骤**:
1. 运行加密测试套件：
   ```bash
   cargo test crypto::aes_gcm::tests -- --nocapture
   ```
2. 验证加密结果
3. 确认篡改检测有效

**验证要点**:
- [ ] 加密后数据不等于原始数据
- [ ] 解密恢复原始数据
- [ ] 篡改任何部分导致解密失败
- [ ] 随机数(nonce)每次不同
- [ ] HMAC完整性验证正确

### 测试流程 3: Shamir秘密共享测试
**目标**: 验证2-of-3秘密恢复机制

**测试步骤**:
1. 运行秘密分享测试：
   ```bash
   cargo test test_secret_sharing_recovery -- --nocapture
   ```
2. 验证分片重建功能

**验证要点**:
- [ ] 32字节密钥正确分割为3个份额
- [ ] 任意2个份额可恢复原始密钥
- [ ] 单个份额无法恢复密钥
- [ ] 重复份额被正确拒绝
- [ ] 恢复的密钥与原始密钥完全一致

### 测试流程 4: 密码库完整工作流
**目标**: 端到端验证密码存储和管理

**测试步骤**:
1. 运行完整工作流测试：
   ```bash
   cargo test test_complete_vault_workflow -- --nocapture
   ```

**验证要点**:
- [ ] 新密码库创建成功
- [ ] 密码条目正确添加
- [ ] 密码库保存到磁盘
- [ ] 关闭并重新加载密码库
- [ ] 数据持久化验证
- [ ] 条目检索正确

**数据完整性验证**:
```bash
# 检查创建的密码库文件
ls -la test_vault.json
file test_vault.json  # 应显示: JSON data

# 验证加密存储（不应包含明文密码）
strings test_vault.json | grep -i "password" || echo "✅ 无明文泄露"
```

### 测试流程 5: 密码库操作验证
**目标**: 验证CRUD操作和搜索功能

**测试步骤**:
1. 运行密码库操作测试：
   ```bash
   cargo test test_vault_operations -- --nocapture
   ```

**验证要点**:
- [ ] 添加多个密码条目
- [ ] UUID正确生成且唯一
- [ ] 搜索功能返回正确结果
- [ ] 条目删除功能正常
- [ ] 获取所有条目列表

### 测试流程 6: 错误处理验证
**目标**: 确保异常情况正确处理

**测试步骤**:
1. 运行错误处理测试：
   ```bash
   cargo test test_error_handling -- --nocapture
   ```

**验证要点**:
- [ ] 删除不存在条目返回错误
- [ ] 无效盐长度被处理
- [ ] 错误消息清晰明确
- [ ] 系统状态保持一致

### 测试流程 7: 并发安全测试
**目标**: 验证多线程环境下的安全性

**测试步骤**:
1. 运行并发测试：
   ```bash
   cargo test test_concurrent_safety -- --nocapture
   ```

**验证要点**:
- [ ] 多线程同时操作无竞态条件
- [ ] 所有条目正确添加
- [ ] UUID保持全局唯一性
- [ ] 无数据丢失或损坏

## 性能基准测试

### 密钥派生性能
**基准目标**: < 5秒
**实际表现**: ~0.1秒 (远超目标)

```bash
cargo test test_key_derivation_performance -- --nocapture
# 期望输出: Key derivation took: ~100ms
```

### 内存使用验证
```bash
# 运行内存检查 (需要安装 valgrind 或类似工具)
cargo test --release
# 检查无内存泄漏警告
```

## 安全验证检查点

### 1. 敏感数据清理验证
**目标**: 确保密码在内存中正确清零

**验证方法**:
```bash
# 运行包含敏感数据的测试
cargo test -- --nocapture

# 检查ZeroizeOnDrop是否正确工作
# (在真实环境中需要内存调试工具)
```

### 2. 文件权限检查
**验证密码库文件安全存储**:

```bash
# 运行测试后检查文件权限
cargo test test_complete_vault_workflow
ls -la test_vault.json
# 确保文件权限合理 (600 或 644)
```

### 3. 加密强度验证
**确认使用行业标准算法**:

- ✅ **AES-256-GCM**: NIST认证的对称加密算法
- ✅ **Argon2id**: OWASP推荐的密钥派生函数  
- ✅ **HMAC-SHA256**: 消息认证码
- ✅ **系统安全随机数**: 密码学级随机数生成

## Touch ID 集成测试

### 可用性检测测试
```bash
cargo test test_availability -- --nocapture
```

**验证要点**:
- [ ] 正确检测Touch ID硬件
- [ ] 在不支持设备上返回false
- [ ] 无崩溃或异常

### 认证测试 (模拟环境)
```bash
cargo test test_authenticate -- --nocapture
```

**注意**: Phase 1使用模拟实现，Phase 2将集成真实Touch ID API

## 故障排除指南

### 常见问题及解决方案

**问题**: 测试编译失败
```bash
# 解决方案: 更新依赖
cargo update
cargo clean
cargo build
```

**问题**: 密钥派生速度过慢
```bash
# 检查系统性能，调整测试超时
# 正常情况下应该 < 1秒完成
```

**问题**: 文件权限错误
```bash
# 确保测试目录有写权限
mkdir -p test_output
chmod 755 test_output
```

## 验收标准

### 功能完整性
- [ ] 48个单元测试全部通过
- [ ] 10个集成测试全部通过
- [ ] 无编译警告或错误
- [ ] 所有手动测试流程验证通过

### 性能要求
- [ ] 密钥派生时间 < 5秒
- [ ] 内存使用合理 (< 100MB测试期间)
- [ ] 文件I/O操作 < 1秒

### 安全标准
- [ ] 敏感数据正确清零
- [ ] 加密算法符合行业标准
- [ ] 无明文密码存储或传输
- [ ] 错误处理不泄露敏感信息

## 测试报告模板

```
测试日期: _______________
测试人员: _______________
环境信息: macOS版本 _____ Rust版本 _____

功能测试结果:
[ ] 密钥派生: 通过/失败 - 耗时: ____ms
[ ] AES-GCM加密: 通过/失败
[ ] 秘密共享: 通过/失败  
[ ] 密码库工作流: 通过/失败
[ ] CRUD操作: 通过/失败
[ ] 错误处理: 通过/失败
[ ] 并发安全: 通过/失败

性能指标:
- 密钥派生时间: ____ms (目标: <5000ms)
- 内存峰值使用: ____MB
- 测试总耗时: ____秒

发现的问题:
1. _________________________________
2. _________________________________

整体评估:
[ ] ✅ 准备进入Phase 2
[ ] ⚠️  需要修复后重测
[ ] ❌ 需要重大改进

签名: _______________
```

## 下一步行动

测试全部通过后：
1. ✅ **Phase 1认证完成** - 核心功能稳定可靠
2. 🚀 **开始Phase 2开发** - GUI和浏览器集成
3. 📋 **持续集成** - 定期回归测试确保稳定性

---

**重要提醒**: 
- 所有测试都应在干净的环境中运行
- 敏感测试应避免在生产环境执行  
- 保存测试结果用于质量追踪
- 任何失败都应详细记录和分析