# 2Password Phase 1 手动测试流程

## 测试概述

本文档提供2Password Phase 1功能的完整手动测试流程，包含关键数据验证点和记录检查要点。

## 测试环境要求

- macOS系统（支持Touch ID）
- Rust 1.70+
- 临时测试目录权限
- 终端访问权限

## 测试模块分类

### 1. 密码库 (Vault) 操作测试

#### 1.1 创建密码库
**测试步骤：**
1. 启动应用程序
2. 选择创建新密码库
3. 输入主密码：`TestMaster123!`
4. 确认密码库创建

**验证要点：**
- [ ] 密码库文件已创建在指定路径
- [ ] 文件格式为加密的JSON结构
- [ ] 包含正确的元数据（format_version=1）
- [ ] 盐值(salt)已生成且长度为32字节
- [ ] 文件大小 > 100字节（包含加密头信息）

**数据检查：**
```bash
# 检查文件存在
ls -la vault.enc
# 检查文件不是纯文本
file vault.enc  # 应显示: data
head -c 50 vault.enc | xxd  # 应显示二进制数据
```

#### 1.2 密码库加载
**测试步骤：**
1. 关闭应用程序
2. 重新启动应用程序
3. 选择加载现有密码库
4. 输入正确主密码：`TestMaster123!`

**验证要点：**
- [ ] 密码库成功解密并加载
- [ ] 主密钥正确派生
- [ ] 内存中密码库状态为已加载
- [ ] 错误密码时拒绝访问

#### 1.3 密码条目管理
**测试步骤：**
1. 添加测试条目：
   - 标题：`github.com`
   - 用户名：`testuser@example.com`
   - 密码：`SuperSecret123!`
   - URL：`https://github.com`
   - 备注：`Work account`
2. 保存条目
3. 搜索条目：`github`
4. 修改条目密码：`NewSecret456!`
5. 删除条目

**验证要点：**
- [ ] UUID正确生成且唯一
- [ ] 创建时间和更新时间正确记录
- [ ] 搜索功能返回正确结果
- [ ] 修改后updated_at时间戳更新
- [ ] 删除后条目不再存在

**数据验证脚本：**
```bash
# 检查条目数据完整性
cargo test test_password_entry_operations -- --nocapture
```

### 2. 密码学功能测试

#### 2.1 密钥派生测试
**测试步骤：**
1. 使用相同密码和盐派生密钥两次
2. 使用不同密码派生密钥
3. 使用不同盐派生密钥

**验证要点：**
- [ ] 相同输入产生相同密钥
- [ ] 不同密码产生不同密钥
- [ ] 不同盐产生不同密钥
- [ ] 密钥长度为32字节
- [ ] 派生时间 < 5秒（默认配置）

**性能基准：**
```bash
cargo test test_key_derivation_performance -- --nocapture
```

#### 2.2 AES-GCM 加密测试
**测试步骤：**
1. 加密测试数据：`Hello, 2Password!`
2. 验证加密输出不等于原始数据
3. 解密数据验证正确性
4. 篡改密文测试解密失败

**验证要点：**
- [ ] 加密输出包含密文、随机数和HMAC
- [ ] 随机数长度为12字节
- [ ] HMAC长度为32字节
- [ ] 篡改任何部分都导致解密失败
- [ ] 相同明文产生不同密文（由于随机数）

#### 2.3 Shamir秘密共享测试
**测试步骤：**
1. 生成32字节测试密钥
2. 分割为3个份额（2-of-3方案）
3. 使用份额1+2恢复密钥
4. 使用份额1+3恢复密钥
5. 使用份额2+3恢复密钥
6. 尝试使用单个份额恢复（应失败）

**验证要点：**
- [ ] 生成3个不同的份额
- [ ] 每个份额都有唯一ID（1,2,3）
- [ ] 任意2个份额能恢复原始密钥
- [ ] 单个份额无法恢复密钥
- [ ] 重复份额拒绝恢复

### 3. 认证功能测试

#### 3.1 Touch ID集成测试
**测试步骤：**
1. 检查Touch ID可用性
2. 触发Touch ID认证提示
3. 使用指纹认证（如果支持）
4. 取消认证测试

**验证要点：**
- [ ] 正确检测Touch ID硬件
- [ ] 认证提示正确显示
- [ ] 成功认证返回true
- [ ] 取消认证返回错误
- [ ] 在不支持的设备上降级处理

#### 3.2 恢复管理器测试
**测试步骤：**
1. 创建恢复管理器实例
2. 检查可用恢复方法
3. 设置主密钥分割
4. 模拟密码+备份恢复

**验证要点：**
- [ ] 至少支持密码恢复方法
- [ ] 如支持Touch ID则包含该方法
- [ ] 包含iCloud备份方法
- [ ] 恢复设置包含所有必要组件
- [ ] 备份数据可序列化和反序列化

### 4. 数据持久化测试

#### 4.1 文件I/O测试
**测试步骤：**
1. 创建密码库并添加多个条目
2. 保存密码库到磁盘
3. 关闭应用程序
4. 重新加载密码库
5. 验证所有数据完整性

**验证要点：**
- [ ] 密码库文件正确保存
- [ ] 重新加载后条目数量正确
- [ ] 所有条目内容匹配
- [ ] 元数据正确保存和恢复
- [ ] 加密完整性保持

#### 4.2 并发安全测试
**测试步骤：**
1. 启动多个线程同时访问密码库
2. 每个线程添加不同的密码条目
3. 等待所有线程完成
4. 验证数据完整性

**验证要点：**
- [ ] 所有条目都成功添加
- [ ] 没有数据丢失或损坏
- [ ] UUID保持唯一性
- [ ] 并发操作不导致崩溃

### 5. 错误处理测试

#### 5.1 输入验证测试
**测试场景：**
- 空密码
- 超长密码（>1000字符）
- 无效字符
- 删除不存在的条目
- 无效的盐长度

**验证要点：**
- [ ] 所有无效输入都被正确拒绝
- [ ] 错误消息清晰明了
- [ ] 系统状态保持一致
- [ ] 没有内存泄漏或崩溃

#### 5.2 文件系统错误测试
**测试场景：**
- 只读目录
- 磁盘空间不足
- 文件权限不足
- 损坏的密码库文件

**验证要点：**
- [ ] 文件系统错误被正确捕获
- [ ] 用户收到适当的错误提示
- [ ] 不产生部分写入的损坏文件
- [ ] 应用程序能优雅降级

## 关键数据验证检查点

### 密码学验证
```bash
# 验证加密强度
openssl rand -hex 32 | xxd  # 对比随机数生成质量
cargo test crypto:: -- --nocapture  # 运行所有密码学测试
```

### 性能验证
```bash
# 密钥派生性能（应在合理时间内完成）
time cargo test test_key_derivation_performance
# 内存使用（检查是否有内存泄漏）
cargo test --verbose 2>&1 | grep -i memory
```

### 数据完整性验证
```bash
# 验证密码库文件结构
hexdump -C vault.enc | head -20  # 检查文件头
stat vault.enc  # 检查文件大小和权限
```

## 测试通过标准

- [ ] 所有自动化测试通过（48个测试）
- [ ] 所有手动测试步骤完成
- [ ] 关键数据验证点确认
- [ ] 性能指标在可接受范围内
- [ ] 错误处理符合预期
- [ ] 数据持久化可靠性确认

## 测试记录模板

```
测试日期：____年____月____日
测试人员：________________
测试环境：________________
测试版本：Phase 1.0

模块测试结果：
[ ] 密码库操作 - 通过/失败
[ ] 密码学功能 - 通过/失败  
[ ] 认证功能 - 通过/失败
[ ] 数据持久化 - 通过/失败
[ ] 错误处理 - 通过/失败

发现问题：
_________________________________

整体评估：
[ ] 准备发布
[ ] 需要修复后重测
[ ] 需要重大修改

备注：
_________________________________
```

## 应急处理

### 数据恢复
如果密码库损坏：
1. 检查备份文件
2. 尝试用不同密码恢复
3. 检查文件系统完整性
4. 使用恢复工具

### 调试信息收集
```bash
# 收集系统信息
system_profiler SPSoftwareDataType
# 收集应用日志
RUST_LOG=debug cargo run 2>&1 | tee debug.log
# 检查权限
ls -la ~/.2password/
```

---

*此文档应在每次Phase 1功能变更后更新，确保测试流程与实际功能同步。*